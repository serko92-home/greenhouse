
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Greenhouse Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.22);
      --accent-blue: #38bdf8;
      --accent-blue-soft: rgba(56, 189, 248, 0.24);
      --border-subtle: #1f2937;
      --border-strong: #374151;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.22);
      --ok-soft: rgba(34, 197, 94, 0.18);
      --chip-bg: rgba(15, 23, 42, 0.75);
      --chip-border: rgba(148, 163, 184, 0.35);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --card-bg: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.22);
      --accent-blue: #38bdf8;
      --accent-blue-soft: rgba(56, 189, 248, 0.24);
      --border-subtle: #1f2937;
      --border-strong: #374151;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.9);
      --chip-bg: rgba(15, 23, 42, 0.9);
      --chip-border: rgba(148, 163, 184, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      background:
        radial-gradient(circle at top, #0f172a 0, #020617 38%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 1.25rem;
    }

    body.dark-theme {
      background:
        radial-gradient(circle at top, #000 0, #020617 40%, #020617 100%);
    }

    .app {
      width: 100%;
      max-width: 960px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .app-title {
      font-weight: 650;
      font-size: 1.6rem;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .app-title-pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(34, 197, 94, 0.45);
    }

    .app-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      max-width: 36rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-radius: 999px;
      padding: 0.18rem 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: #cbd5f5;
      background: linear-gradient(
        120deg,
        rgba(15, 23, 42, 0.65),
        rgba(15, 23, 42, 0.2)
      );
    }

    .last-update {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 1rem;
    }

    @media (max-width: 760px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      position: relative;
      background: radial-gradient(
          circle at top left,
          rgba(34, 197, 94, 0.06),
          transparent 60%
        ),
        radial-gradient(
          circle at top right,
          rgba(56, 189, 248, 0.08),
          transparent 55%
        ),
        linear-gradient(145deg, #020617, #020617);
      border-radius: 1.1rem;
      padding: 0.95rem 1.05rem 1.05rem;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #cbd5f5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.55rem;
    }

    .card-title span.sub {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-muted);
      text-transform: none;
      letter-spacing: normal;
    }

    .card-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .chip {
      border-radius: 999px;
      padding: 0.45rem 0.7rem;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      display: inline-flex;
      align-items: baseline;
      gap: 0.45rem;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .chip-label {
      text-transform: uppercase;
      font-size: 0.68rem;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .chip-value {
      font-variant-numeric: tabular-nums;
    }

    .chip-pill {
      border-radius: 999px;
      padding: 0.08rem 0.4rem;
      border: 1px solid rgba(156, 163, 175, 0.65);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .chip-pill.ok {
      border-color: rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
      background: var(--ok-soft);
    }

    .chip-pill.warn {
      border-color: rgba(250, 204, 21, 0.8);
      color: #fef9c3;
      background: rgba(250, 204, 21, 0.2);
    }

    .chip-pill.danger {
      border-color: rgba(248, 113, 113, 0.85);
      color: #fee2e2;
      background: var(--danger-soft);
    }

    .section-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    .recommendation-block {
      font-size: 0.82rem;
      line-height: 1.5;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .recommendation-block strong {
      color: #bbf7d0;
    }

    .recommendation-list {
      margin: 0.25rem 0 0;
      padding-left: 1.05rem;
      display: grid;
      gap: 0.15rem;
    }

    .recommendation-list li {
      font-size: 0.8rem;
      color: var(--text-main);
    }

    .data-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .metric {
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
      font-size: 0.78rem;
    }

    .metric-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.68rem;
    }

    .metric-value {
      font-variant-numeric: tabular-nums;
      font-size: 0.86rem;
    }

    .metric-note {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .mode-tag {
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #bfdbfe;
      background: linear-gradient(
        120deg,
        rgba(59, 130, 246, 0.24),
        rgba(59, 130, 246, 0.06)
      );
    }

    .mode-tag.winter {
      border-color: rgba(56, 189, 248, 0.7);
      background: linear-gradient(
        120deg,
        rgba(56, 189, 248, 0.2),
        rgba(15, 23, 42, 0.8)
      );
      color: #cffafe;
    }

    .mode-tag.wakeup {
      border-color: rgba(250, 204, 21, 0.75);
      background: linear-gradient(
        120deg,
        rgba(250, 204, 21, 0.2),
        rgba(15, 23, 42, 0.85)
      );
      color: #fef9c3;
    }

    .mode-tag.active {
      border-color: rgba(34, 197, 94, 0.9);
      background: linear-gradient(
        120deg,
        rgba(34, 197, 94, 0.22),
        rgba(15, 23, 42, 0.85)
      );
      color: #bbf7d0;
    }

    .field {
      margin-bottom: 0.7rem;
    }

    .field label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }

    .field-row input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
    }

    .field-value {
      font-size: 0.82rem;
      font-variant-numeric: tabular-nums;
      min-width: 3.2rem;
      text-align: right;
    }

    .mode-row {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.7rem;
    }

    .mode-row label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .mode-row select {
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
      font-size: 0.8rem;
      outline: none;
    }

    .primary-btn {
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.9rem;
      font-size: 0.82rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(
        135deg,
        rgba(34, 197, 94, 0.9),
        rgba(22, 163, 74, 0.98)
      );
      color: #052e16;
      box-shadow: 0 10px 25px rgba(22, 163, 74, 0.5);
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.6);
    }

    .controls-card {
      margin-top: 0.25rem;
    }

    .controls-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .controls-summary {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls-toggle-btn {
      border: none;
      background: transparent;
      color: var(--accent);
      font-size: 0.82rem;
      cursor: pointer;
      padding: 0;
    }

    .controls-toggle-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .controls-body {
      margin-top: 0.6rem;
    }

    .sky-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .sky-icon {
      font-size: 1.2rem;
      line-height: 1;
    }

    .theme-card {
      margin-top: 0.25rem;
    }

    .theme-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .theme-label {
      font-weight: 600;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .theme-toggle {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      font-size: 0.82rem;
      cursor: pointer;
      user-select: none;
    }

    .theme-toggle input {
      display: none;
    }

    .theme-toggle-knob {
      width: 40px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--accent-soft);
      position: relative;
      transition: background 150ms ease, border-color 150ms ease;
    }

    .theme-toggle-knob::before {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: white;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.35);
      transition: transform 150ms ease;
    }

    body.dark-theme .theme-toggle-knob {
      background: var(--accent-blue-soft);
    }

    body.dark-theme .theme-toggle-knob::before {
      transform: translateX(16px);
    }

    .footer-note {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: -0.25rem;
    }

    a {
      color: var(--accent-blue);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-block">
        <div class="app-title">
          <span>Greenhouse Helper</span>
          <span class="app-title-pill">Lemongrass winter mode</span>
        </div>
        <div class="app-subtitle">
          Uses Ubibot readings to decide when to relax, vent or protect the greenhouse. 
          Slider controls the vent opening and the mode picks how aggressive you want to be.
        </div>
        <div class="badge-row">
          <span class="badge">Thermostat 50F</span>
          <span class="badge">Outdoor probe</span>
          <span class="badge">Lux based sky guess</span>
        </div>
      </div>
      <div class="last-update">
        Last updated<br />
        <span id="lastUpdated">never</span>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="card-title">
          Current readings
          <span class="sub">From Ubibot channel 116552</span>
        </div>

        <div class="section-label">Environment</div>
        <div class="card-row">
          <div class="chip">
            <div class="chip-label">Outside</div>
            <div class="chip-value">
              <span id="outTempLabel">--</span> F, 
              <span id="outHumLabel">--</span> %
            </div>
          </div>
          <div class="chip">
            <div class="chip-label">Inside</div>
            <div class="chip-value">
              <span id="inTempLabel">--</span> F, 
              <span id="inHumLabel">--</span> %
            </div>
          </div>
        </div>

        <div class="section-label">Light and sky</div>
        <div class="card-row">
          <div class="chip">
            <div class="chip-label">Light</div>
            <div class="chip-value">
              <span id="luxLabel">--</span> lux
            </div>
          </div>
          <div class="chip sky-chip">
            <span id="skyIcon" class="sky-icon" aria-hidden="true">‚õÖÔ∏è</span>
            <div class="chip-label">Sky</div>
            <div class="chip-value" id="skyLabel">No reading yet</div>
          </div>
        </div>

        <div class="data-grid">
          <div class="metric">
            <div class="metric-label">Heating pad</div>
            <div class="metric-value" id="heatStatus">Unknown</div>
            <div class="metric-note" id="heatNote"></div>
          </div>
          <div class="metric">
            <div class="metric-label">Vent suggestion</div>
            <div class="metric-value" id="ventSuggestion">Awaiting data</div>
            <div class="metric-note" id="ventNote"></div>
          </div>
        </div>

        <div class="section-label">Mode snapshot</div>
        <div class="card-row">
          <span id="modeTag" class="mode-tag winter">Winter - keep roots safe</span>
          <span class="chip-pill" id="hintChip">Waiting for live data</span>
        </div>
      </section>

      <section class="card">
        <div class="card-title">
          Recommendations
          <span class="sub">Based on current readings and controls</span>
        </div>

        <div class="section-label">What to know</div>
        <div class="recommendation-block" id="summaryBlock">
          <span id="summaryLine">Waiting for first reading. Connect to the network and tap Update.</span>
        </div>

        <div class="section-label" style="margin-top:0.7rem;">Next steps</div>
        <ul class="recommendation-list" id="actionsList">
          <li>Once data loads, you will see concrete vent and pad instructions here.</li>
        </ul>

        <div class="card controls-card">
          <div class="card-title controls-header">
            <span class="controls-summary" id="controlsSummary">
              Controls | Mode: Winter - Vent: 1.0 in.
            </span>
            <button
              type="button"
              class="controls-toggle-btn"
              id="controlsToggle"
              aria-expanded="false"
            >
              Expand
            </button>
          </div>

          <div id="controlsBody" class="controls-body">
            <div class="field">
              <label for="ventSlider">
                Vent opening
                <span class="field-value"><span id="ventLabel">1.0</span> in</span>
              </label>
              <div class="field-row">
                <input id="ventSlider" type="range" min="0" max="10" step="0.5" value="1" />
              </div>
              <input type="hidden" id="ventInches" value="1">
            </div>

            <div class="mode-row">
              <label for="mode">Mode</label>
              <select id="mode">
                <option value="winter">Winter</option>
                <option value="wakeup">Wake up</option>
                <option value="active">Active growth</option>
              </select>
            </div>

            <button type="button" class="primary-btn" id="updateBtn">Update</button>
          </div>
        </div>

        <div class="card theme-card">
          <div class="theme-row">
            <span class="theme-label">Theme</span>
            <label class="theme-toggle">
              <span id="themeToggleLabel">Dark</span>
              <input id="themeToggle" type="checkbox" checked />
              <span class="theme-toggle-knob"></span>
            </label>
          </div>
        </div>
      </section>
    </main>

    <p class="footer-note">
      Heating pad indicator assumes the pad thermostat clicks on when inside temperature is below 50 F. 
      Adjust logic in the script at the bottom if your hardware behaves differently.
    </p>
  </div>

  <script>
    const UBI_URL =
      "https://webapi.ubibot.com/channels/116552?api_key=1b96d5173ae6435faaf2f61f474af06d";
    const HEAT_THRESHOLD_F = 50;
    const STORAGE_KEY = "greenhouseHelperState_v2";
    const THEME_KEY = "greenhouseHelperTheme";

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value;
      }
    }

    function round(value, digits) {
      const d = typeof digits === "number" ? digits : 1;
      const n = Number(value);
      if (!Number.isFinite(n)) return value;
      return n.toFixed(d);
    }

    function luxBucket(lux) {
      if (!Number.isFinite(lux)) return { bucket: "unknown", label: "No reading yet" };
      if (lux < 5) return { bucket: "dark", label: "Dark" };
      if (lux < 80) return { bucket: "very_low", label: "Very low light" };
      if (lux < 3500) return { bucket: "cloudy", label: "Cloudy or shade" };
      if (lux < 15000) return { bucket: "bright", label: "Bright, filtered sun" };
      return { bucket: "full_sun", label: "Full sun" };
    }

    function updateSkyIcon(info) {
      const iconEl = document.getElementById("skyIcon");
      const labelEl = document.getElementById("skyLabel");
      if (!iconEl) return;

      if (!info) {
        const luxText = document.getElementById("luxLabel")?.textContent || "";
        const luxValue = parseFloat(luxText);
        info = luxBucket(luxValue);
      }

      let emoji = "‚õÖÔ∏è";
      switch (info.bucket) {
        case "dark":
          emoji = "üåô";
          break;
        case "very_low":
          emoji = "üåí";
          break;
        case "cloudy":
          emoji = "‚òÅÔ∏è";
          break;
        case "bright":
          emoji = "üå§";
          break;
        case "full_sun":
          emoji = "‚òÄÔ∏è";
          break;
      }

      iconEl.textContent = emoji;
      if (labelEl && info.label) {
        labelEl.textContent = info.label;
      }
      iconEl.title = info.label || "";
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      const body = document.body;
      const isDark = theme === "dark";
      if (root) {
        root.setAttribute("data-theme", isDark ? "dark" : "light");
      }
      if (body) {
        body.classList.toggle("dark-theme", isDark);
      }
      const label = document.getElementById("themeToggleLabel");
      const toggle = document.getElementById("themeToggle");
      if (label) {
        label.textContent = isDark ? "Dark" : "Light";
      }
      if (toggle && toggle.checked !== isDark) {
        toggle.checked = isDark;
      }
    }

    function initTheme() {
      let stored = null;
      try {
        stored = localStorage.getItem(THEME_KEY);
      } catch (e) {}

      const prefersDark =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      const theme =
        stored === "light" || stored === "dark"
          ? stored
          : prefersDark
          ? "dark"
          : "light";

      applyTheme(theme);

      const toggle = document.getElementById("themeToggle");
      if (toggle) {
        toggle.addEventListener("change", () => {
          const newTheme = toggle.checked ? "dark" : "light";
          applyTheme(newTheme);
          try {
            localStorage.setItem(THEME_KEY, newTheme);
          } catch (e) {}
        });
      }
    }

    function setControlsExpanded(expanded) {
      const body = document.getElementById("controlsBody");
      const toggle = document.getElementById("controlsToggle");
      if (!body || !toggle) return;
      body.style.display = expanded ? "block" : "none";
      toggle.textContent = expanded ? "Collapse" : "Expand";
      toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
    }

    function updateControlsSummary() {
      const modeSelect = document.getElementById("mode");
      const ventLabel = document.getElementById("ventLabel");
      const summaryEl = document.getElementById("controlsSummary");
      if (!summaryEl || !modeSelect || !ventLabel) return;
      const modeText =
        modeSelect.options[modeSelect.selectedIndex]?.text ||
        modeSelect.value ||
        "Unknown";
      const ventText = ventLabel.textContent || "?";
      summaryEl.textContent =
        "Controls | Mode: " + modeText + " - Vent: " + ventText + " in.";
      const modeTag = document.getElementById("modeTag");
      if (modeTag) {
        modeTag.textContent =
          modeText +
          (modeSelect.value === "winter"
            ? " - keep roots safe"
            : modeSelect.value === "wakeup"
            ? " - gentle wake up"
            : " - push growth");
        modeTag.classList.remove("winter", "wakeup", "active");
        if (modeSelect.value === "winter") modeTag.classList.add("winter");
        else if (modeSelect.value === "wakeup") modeTag.classList.add("wakeup");
        else modeTag.classList.add("active");
      }
    }

    function initControls() {
      const slider = document.getElementById("ventSlider");
      const label = document.getElementById("ventLabel");
      const hidden = document.getElementById("ventInches");
      const modeSelect = document.getElementById("mode");
      const toggle = document.getElementById("controlsToggle");
      const updateBtn = document.getElementById("updateBtn");

      if (!slider || !label || !hidden) return;

      slider.addEventListener("input", () => {
        const v = Number(slider.value);
        label.textContent = v.toFixed(1);
        hidden.value = v;
        updateControlsSummary();
      });

      if (modeSelect) {
        modeSelect.addEventListener("change", () => {
          updateControlsSummary();
        });
      }

      if (toggle) {
        toggle.addEventListener("click", () => {
          const expanded = toggle.getAttribute("aria-expanded") === "true";
          setControlsExpanded(!expanded);
        });
      }

      if (updateBtn) {
        updateBtn.addEventListener("click", () => {
          compute();
          setControlsExpanded(false);
        });
      }

      updateControlsSummary();
      setControlsExpanded(false);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s.ventInches != null) {
          const slider = document.getElementById("ventSlider");
          const ventHidden = document.getElementById("ventInches");
          if (slider) slider.value = s.ventInches;
          if (ventHidden) ventHidden.value = s.ventInches;
          setText("ventLabel", Number(s.ventInches).toFixed(1));
        }
        if (s.mode) {
          const mode = document.getElementById("mode");
          if (mode) mode.value = s.mode;
        }
      } catch (e) {}
      updateControlsSummary();
    }

    function saveState(partial) {
      let base = {};
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) base = JSON.parse(raw) || {};
      } catch (e) {}
      const merged = Object.assign({}, base, partial || {});
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
      } catch (e) {}
    }

    function guessVent(inTemp, outTemp, mode) {
      if (!Number.isFinite(inTemp) || !Number.isFinite(outTemp)) {
        return {
          inches: null,
          text: "No suggestion",
          note: "Waiting for both inside and outside temperatures."
        };
      }
      const diff = inTemp - outTemp;
      let base = 1;
      if (mode === "winter") {
        if (inTemp < 40) base = 0;
        else if (diff > 10) base = 0.5;
        else base = 1;
      } else if (mode === "wakeup") {
        base = diff > 12 ? 1 : 1.5;
      } else {
        base = diff > 15 ? 2 : 3;
      }
      base = Math.max(0, Math.min(10, base));
      const note =
        mode === "winter"
          ? "Keep opening tiny unless inside is far above freezing."
          : mode === "wakeup"
          ? "Let some cool air in without shocking the roots."
          : "Vent more freely during strong growth.";
      return {
        inches: base,
        text: base.toFixed(1) + " in",
        note
      };
    }

    function compute() {
      const inTemp = parseFloat(
        document.getElementById("inTempLabel")?.textContent
      );
      const outTemp = parseFloat(
        document.getElementById("outTempLabel")?.textContent
      );
      const inHum = parseFloat(
        document.getElementById("inHumLabel")?.textContent
      );
      const lux = parseFloat(
        document.getElementById("luxLabel")?.textContent
      );
      const modeSelect = document.getElementById("mode");
      const ventHidden = document.getElementById("ventInches");
      const ventManual = ventHidden ? parseFloat(ventHidden.value) : NaN;
      const mode = modeSelect ? modeSelect.value : "winter";

      const padOn =
        Number.isFinite(inTemp) && inTemp < HEAT_THRESHOLD_F ? "ON" : "OFF";

      setText("heatStatus", padOn);
      const heatNote =
        !Number.isFinite(inTemp)
          ? "Waiting for inside temperature read."
          : padOn === "ON"
          ? "Inside is below " +
            HEAT_THRESHOLD_F +
            " F so the thermostat should be feeding the pad."
          : "Inside is above " +
            HEAT_THRESHOLD_F +
            " F so the pad thermostat should be idle.";
      setText("heatNote", heatNote);

      const vGuess = guessVent(inTemp, outTemp, mode);
      const ventSuggestionText = vGuess.text;
      const ventNote =
        Number.isFinite(ventManual) && Number.isFinite(vGuess.inches)
          ? "You set " +
            ventManual.toFixed(1) +
            " in, helper suggests about " +
            vGuess.inches.toFixed(1) +
            " in."
          : vGuess.note;
      setText("ventSuggestion", ventSuggestionText);
      setText("ventNote", ventNote);

      const luxInfo = luxBucket(lux);
      updateSkyIcon(luxInfo);

      const actions = [];
      let summary = "";

      if (!Number.isFinite(inTemp) || !Number.isFinite(outTemp)) {
        summary =
          "Waiting for a full set of readings before giving serious advice.";
        actions.push(
          "Check Wi Fi and probe connections if values stay blank for a while.",
          "You can still move the vent slider and use your own judgement."
        );
      } else if (mode === "winter") {
        if (inTemp < 35) {
          summary =
            "Roots are in the danger zone. Keep things tightly closed and let the pad work.";
          actions.push(
            "Close vents fully or almost fully until inside creeps back above 38 F.",
            "If a long freeze is coming, consider extra insulation or an emergency blanket."
          );
        } else if (inTemp < 45) {
          summary =
            "Good winter range. Let the pad quietly maintain soil warmth.";
          actions.push(
            "Keep vent opening small, around " +
              vGuess.inches.toFixed(1) +
              " in.",
            "If sky icon shows full sun and lux is high, you can crack the vent a little more for a couple of hours."
          );
        } else {
          summary =
            "Inside is comfortably above freezing. You can trade a bit of heat for fresh air.";
          actions.push(
            "Use the helper suggestion for vent or go slightly higher if lux says full sun.",
            "If outside suddenly drops while inside stays warm, shrink the vent again toward 0.5 in."
          );
        }
      } else if (mode === "wakeup") {
        summary =
          "You are easing the plants out of dormancy. Protect roots but allow a gentle daily swing.";
        actions.push(
          "Aim for small daily highs in the low 60s inside, lows near 40 to 45 F.",
          "On bright calm days open vent toward " +
            vGuess.inches.toFixed(1) +
            " in, but close most of the way again near sunset."
        );
      } else {
        summary =
          "Active growth mode trades some safety margin for faster top growth.";
        actions.push(
          "On sunny days with calm wind, it is fine to open vent to " +
            vGuess.inches.toFixed(1) +
            " in or your own manual value.",
          "If a cold front is coming, temporarily behave more like Wake up mode for a day or two."
        );
      }

      if (Number.isFinite(inHum)) {
        if (inHum < 25) {
          actions.push(
            "Humidity is very low. Add a tray of water or mist foliage occasionally."
          );
        } else if (inHum > 85) {
          actions.push(
            "Humidity is high. Favor a bit more venting when temperature allows to avoid mildew."
          );
        }
      }

      setText("summaryLine", summary);
      const list = document.getElementById("actionsList");
      if (list) {
        list.innerHTML = "";
        actions.forEach((t) => {
          const li = document.createElement("li");
          li.textContent = t;
          list.appendChild(li);
        });
      }

      const hintChip = document.getElementById("hintChip");
      if (hintChip) {
        if (!Number.isFinite(inTemp) || !Number.isFinite(outTemp)) {
          hintChip.textContent = "Partial data";
          hintChip.className = "chip-pill warn";
        } else if (inTemp < 30) {
          hintChip.textContent = "Freeze risk";
          hintChip.className = "chip-pill danger";
        } else if (inTemp < 40) {
          hintChip.textContent = "Watch temps";
          hintChip.className = "chip-pill warn";
        } else {
          hintChip.textContent = "Stable for now";
          hintChip.className = "chip-pill ok";
        }
      }

      try {
        saveState({
          ventInches: ventManual,
          mode,
        });
      } catch (e) {}

      const now = new Date();
      const stamp =
        now.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        }) +
        " " +
        now.toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        });
      setText("lastUpdated", stamp);
      updateControlsSummary();
    }

    async function fetchUbibot() {
      try {
        const res = await fetch(UBI_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        let last = null;

        if (Array.isArray(data.feeds) && data.feeds.length) {
          last = data.feeds[data.feeds.length - 1];
        } else if (data.last_values) {
          last = data.last_values;
        }

        if (!last) {
          console.warn("Ubibot data format not recognized", data);
          return;
        }

        const tOut = parseFloat(last.field8 ?? last.field4 ?? last.field1);
        const hOut = parseFloat(last.field2);
        const tIn = parseFloat(last.field1);
        const hIn = parseFloat(last.field2);
        const lux = parseFloat(last.field3);

        if (Number.isFinite(tOut)) setText("outTempLabel", round(tOut, 1));
        if (Number.isFinite(hOut)) setText("outHumLabel", round(hOut, 0));
        if (Number.isFinite(tIn)) setText("inTempLabel", round(tIn, 1));
        if (Number.isFinite(hIn)) setText("inHumLabel", round(hIn, 0));
        if (Number.isFinite(lux)) setText("luxLabel", round(lux, 0));

        const info = luxBucket(lux);
        updateSkyIcon(info);
      } catch (e) {
        console.warn("Ubibot fetch failed", e);
        const hintChip = document.getElementById("hintChip");
        if (hintChip) {
          hintChip.textContent = "Offline mode";
          hintChip.className = "chip-pill warn";
        }
      }
    }

    window.addEventListener("load", () => {
      initTheme();
      initControls();
      loadState();
      fetchUbibot().finally(() => {
        compute();
      });
    });
  </script>
</body>
</html>
